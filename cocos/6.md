# 引擎中的系统运作与组成
_Exported on 7/14/2025 at 14:30:09 GMT+8 from Cursor (1.2.4)_

---

**User**

引擎之中_systems是如何运作的呢？还有引擎中都有哪些系统呢？

---

**Cursor**

```typescript
// Update systems
for (let i = 0; i < this._systems.length; ++i) {
    this._systems[i].update(dt);
}

// Post update systems
for (let i = 0; i < this._systems.length; ++i) {
    this._systems[i].postUpdate(dt);
}
```

我来帮你分析Cocos Creator引擎中的`_systems`机制以及都有哪些系统。

基于对Cocos Creator引擎源码的分析，我来详细解释`_systems`的运作机制以及引擎中的各种系统。

## `_systems`的运作机制

### 1. 基础架构

```12:15:cocos-engine/cocos/core/system.ts
export class System implements ISchedulable {
    static Priority = Enum({
        LOW: SystemPriority.LOW,
        MEDIUM: SystemPriority.MEDIUM,
        HIGH: SystemPriority.HIGH,
        SCHEDULER: SystemPriority.SCHEDULER,
    });
```

所有系统都继承自`System`基类，具有以下核心方法：
- `init()`: 系统初始化
- `update(dt)`: 每帧更新逻辑
- `postUpdate(dt)`: 后处理更新
- `destroy()`: 销毁清理

### 2. 系统注册与管理

```697:711:cocos-engine/cocos/game/director.ts
    /**
     * @en Register a system.
     * @zh 注册一个系统。
     */
    public registerSystem (name: string, sys: System, priority: number): void {
        sys.id = name;
        sys.priority = priority;
        this._systems.push(sys);
        this._systems.sort(System.sortByPriority);
    }

    public unregisterSystem (sys: System): void {
        js.array.fastRemove(this._systems, sys);
        this._systems.sort(System.sortByPriority);
    }
```

系统按优先级排序，优先级越高越先执行。

### 3. 系统执行流程

在Director的主循环`tick()`中，系统按以下顺序执行：

```825:860:cocos-engine/cocos/game/director.ts
            // Update systems
            for (let i = 0; i < this._systems.length; ++i) {
                this._systems[i].update(dt);
            }
            // Late update for components
            this._compScheduler.lateUpdatePhase(dt);
            // User can use this event to do things after update
            this.emit(DirectorEvent.AFTER_UPDATE);
            // Destroy entities that have been removed recently
            CCObject._deferredDestroy();

            // Post update systems
            for (let i = 0; i < this._systems.length; ++i) {
                this._systems[i].postUpdate(dt);
            }
```

执行顺序：
1. 组件的start阶段
2. 组件的update阶段  
3. **系统的update阶段**
4. 组件的lateUpdate阶段
5. **系统的postUpdate阶段**

## 引擎中的主要系统

### 1. **Scheduler (调度器)**
- **优先级**: 200 (最高)
- **功能**: 管理用户注册的定时任务和回调
- **默认注册**: 是

### 2. **AnimationManager (动画管理器)**
```40:80:cocos-engine/cocos/animation/animation-manager.ts
export class AnimationManager extends System {
    public static ID = 'animation';
    // 管理所有动画状态
    private _anims = new js.array.MutableForwardIterator<AnimationState>([]);
    // 管理交叉淡入淡出
    private _crossFades = new js.array.MutableForwardIterator<CrossFade>([]);
```
- **优先级**: HIGH (200)
- **功能**: 管理骨骼动画、关键帧动画等
- **自动注册**: 是

### 3. **TweenSystem (补间动画系统)**
```35:80:cocos-engine/cocos/tween/tween-system.ts
export class TweenSystem extends System {
    static readonly ID = 'TWEEN';
    
    update (dt: number): void {
        if (!EDITOR_NOT_IN_PREVIEW || this._executeInEditMode) {
            this.actionMgr.update(dt);
        }
    }
}
```
- **优先级**: MEDIUM (100)
- **功能**: 处理补间动画和Actions
- **自动注册**: 是

### 4. **PhysicsSystem (3D物理系统)**
```46:200:cocos-engine/cocos/physics/framework/physics-system.ts
export class PhysicsSystem extends System implements IWorldInitData {
    public static readonly ID = 'PHYSICS';
    
    postUpdate (deltaTime: number): void {
        if (!this._enable) {
            return;
        }
        // 物理模拟更新
        director.emit(DirectorEvent.BEFORE_PHYSICS);
        // 同步场景到物理世界
        this.syncSceneToPhysics();
        // 执行物理步进
        this.step(this._fixedTimeStep, deltaTime, this._maxSubSteps);
        // 发射碰撞事件
        this.emitEvents();
        director.emit(DirectorEvent.AFTER_PHYSICS);
    }
}
```
- **优先级**: 可配置
- **功能**: 3D物理碰撞检测、刚体模拟
- **支持**: Bullet、PhysX等物理引擎

### 5. **PhysicsSystem2D (2D物理系统)**
- **功能**: 2D物理碰撞检测、刚体模拟  
- **支持**: Box2D物理引擎

### 6. **SkeletonSystem (Spine动画系统)**
- **功能**: 处理Spine骨骼动画
- **优先级**: 可配置

### 7. **ArmatureSystem (DragonBones动画系统)**
- **功能**: 处理DragonBones骨骼动画
- **优先级**: 可配置

### 8. **Profiler (性能分析系统)**
```94:170:cocos-engine/cocos/profiler/profiler.ts
export class Profiler extends System {
    private _profilerStats: IProfilerState | null = null;
    
    init (): void {
        const showFPS = !!settings.querySettings(SettingsCategory.PROFILING, 'showFPS');
        if (showFPS) {
            this.showStats();
        }
    }
}
```
- **功能**: 性能监控、FPS显示、内存统计
- **可选**: 根据设置开启

### 9. **DynamicAtlasManager (动态图集管理器)**
```44:120:cocos-engine/cocos/2d/utils/dynamic-atlas/atlas-manager.ts
export class DynamicAtlasManager extends System {
    public static instance: DynamicAtlasManager;
    
    public packToDynamicAtlas (comp, frame: SpriteFrame | null): void {
        // 将图片打包到动态图集中
    }
}
```
- **优先级**: 0 (最低)
- **功能**: UI渲染优化，动态合并小图
- **自动注册**: 是

### 10. **View (UI视图系统)**
- **优先级**: 0
- **功能**: UI适配、屏幕分辨率管理

## 系统注册示例

大多数系统在`DirectorEvent.INIT`事件中自动注册：

```typescript
director.on(DirectorEvent.INIT, (): void => {
    const animationManager = new AnimationManager();
    director.registerSystem(AnimationManager.ID, animationManager, SystemPriority.HIGH);
});
```

这种设计保证了：
1. **模块化**: 每个功能独立为系统
2. **可扩展**: 用户可以注册自定义系统
3. **有序执行**: 按优先级确保执行顺序
4. **性能优化**: 统一的更新循环避免频繁的函数调用开销

```typescript
export class System implements ISchedulable {
    static Priority = Enum({
        LOW: SystemPriority.LOW,
        MEDIUM: SystemPriority.MEDIUM,
        HIGH: SystemPriority.HIGH,
        SCHEDULER: SystemPriority.SCHEDULER,
    });
```

```typescript
    /**
     * @en Register a system.
     * @zh 注册一个系统。
     */
    public registerSystem (name: string, sys: System, priority: number): void {
        sys.id = name;
        sys.priority = priority;
        this._systems.push(sys);
        this._systems.sort(System.sortByPriority);
    }

    public unregisterSystem (sys: System): void {
        js.array.fastRemove(this._systems, sys);
        this._systems.sort(System.sortByPriority);
    }
```

```typescript
            // Update systems
            for (let i = 0; i < this._systems.length; ++i) {
                this._systems[i].update(dt);
            }
            // Late update for components
            this._compScheduler.lateUpdatePhase(dt);
            // User can use this event to do things after update
            this.emit(DirectorEvent.AFTER_UPDATE);
            // Destroy entities that have been removed recently
            CCObject._deferredDestroy();

            // Post update systems
            for (let i = 0; i < this._systems.length; ++i) {
                this._systems[i].postUpdate(dt);
            }
```

```typescript
export class AnimationManager extends System {
    public static ID = 'animation';
    // 管理所有动画状态
    private _anims = new js.array.MutableForwardIterator<AnimationState>([]);
    // 管理交叉淡入淡出
    private _crossFades = new js.array.MutableForwardIterator<CrossFade>([]);
```

```typescript
export class TweenSystem extends System {
    static readonly ID = 'TWEEN';
    
    update (dt: number): void {
        if (!EDITOR_NOT_IN_PREVIEW || this._executeInEditMode) {
            this.actionMgr.update(dt);
        }
    }
}
```

```typescript
export class PhysicsSystem extends System implements IWorldInitData {
    public static readonly ID = 'PHYSICS';
    
    postUpdate (deltaTime: number): void {
        if (!this._enable) {
            return;
        }
        // 物理模拟更新
        director.emit(DirectorEvent.BEFORE_PHYSICS);
        // 同步场景到物理世界
        this.syncSceneToPhysics();
        // 执行物理步进
        this.step(this._fixedTimeStep, deltaTime, this._maxSubSteps);
        // 发射碰撞事件
        this.emitEvents();
        director.emit(DirectorEvent.AFTER_PHYSICS);
    }
}
```

```typescript
export class Profiler extends System {
    private _profilerStats: IProfilerState | null = null;
    
    init (): void {
        const showFPS = !!settings.querySettings(SettingsCategory.PROFILING, 'showFPS');
        if (showFPS) {
            this.showStats();
        }
    }
}
```

```typescript
export class DynamicAtlasManager extends System {
    public static instance: DynamicAtlasManager;
    
    public packToDynamicAtlas (comp, frame: SpriteFrame | null): void {
        // 将图片打包到动态图集中
    }
}
```

```typescript
director.on(DirectorEvent.INIT, (): void => {
    const animationManager = new AnimationManager();
    director.registerSystem(AnimationManager.ID, animationManager, SystemPriority.HIGH);
});
```

